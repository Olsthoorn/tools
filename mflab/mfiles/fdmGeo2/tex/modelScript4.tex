\begin{alltt}
\textcolor{comment}{%\%\% ModelScript -- Example 4 sets up 2D FDM, runs it and then runs }
\textcolor{comment}{%   Runs a particle tracking model (Moc method of characteristics)}
\textcolor{comment}{%   Shows the results}
\textcolor{comment}{%   TO 140417}

\textcolor{comment}{%\% Cleanup}
close all;

\textcolor{comment}{%\% Constants used in IBOUND}
FXHD     = -1;
INACTIVE =  0;
ACTIVE   =  1;

clr = \textcolor{string}{'brgkmcy'};  \textcolor{comment}{% list of colors}

\textcolor{comment}{%\% Generate the Grid for th FDM flow modoel}
xGr   = 0:100:5000;
yGr   = 0:100:5000;
zGr   = [0 -100];
gr    =  grid2DObj(xGr,yGr,zGr); \textcolor{comment}{% generates 2D gridObj with depth}

\textcolor{comment}{% Show the grid}
figure; hold on;
xlabel(\textcolor{string}{'x [m]'}); ylabel(\textcolor{string}{'y [m]'});
title(\textcolor{string}{'example2: MOC, flow from left to right'});
gr.plot(\textcolor{string}{'c'});  \textcolor{comment}{% lines in cyan color}

\textcolor{comment}{%\% Transmissivities}
Tx = gr.const(600);
Ty = gr.const(600);

\textcolor{comment}{%\% Recharge}
rch   = 0.001; \textcolor{comment}{% net recharge rate}
FQ    = gr.Area * rch;

\textcolor{comment}{%\% Wells}
well = [1500,2000,-2400
        3500,3500,-2400];

Idwell     = gr.Idx(well(:,1),well(:,2));
FQ(Idwell) = well(:,3);

IH  = gr.const(0);

\textcolor{comment}{%\% IBOUND (specifies where heads are fixed)}
IBOUND = ones(gr.size);
IBOUND(:,[1 end]) = FXHD;
IBOUND([1 end],:) = FXHD;

\textcolor{comment}{%\% Run the flow model}
[Phi,Q,Qx,Qy] = fdm2(gr,Tx,Ty,IBOUND,IH,FQ);

\textcolor{comment}{%\% Setup the particle tracking model}
t    = 0:500:150000; \textcolor{comment}{% times}
Peff = gr.const(0.35); \textcolor{comment}{% effective porosity}

aL   = 100;   \textcolor{comment}{% [ m ] longitudinal dispersivity}
aT   = aL/10; \textcolor{comment}{% [ m ] transversal dispersivity}
Diff = 1e-4;  \textcolor{comment}{% [m2/d] diffusion coefficient}
R    = 2;     \textcolor{comment}{% [ - ] retardation}
lambda = 2e-5;\textcolor{comment}{% [1/d] decay}

\textcolor{comment}{%\% Generate starting particles and run MOC}
swarm      = true;   \textcolor{comment}{% a swarm of particles}
pointSwarm = true;   \textcolor{comment}{% several point swamrs of particles}

\textcolor{keyword}{if} swarm
    Np =25000;
    \textcolor{keyword}{if} \~{}pointSwarm
        x = (rand(Np,1)-0.5)*1000 + gr.xm(round(gr.Nx/2)) ;
        y = (rand(Np,1)-0.5)*1000 + gr.ym(round(gr.Ny/3)) ;
        
        P = Moc(gr,Qx,Qy,Peff,R,t,x,y ,\textcolor{string}{'aL'},aL,\textcolor{string}{'aT'},aT,\textcolor{string}{'Diff'},Diff,\textcolor{string}{'lambda'},lambda);

    \textcolor{keyword}{else} \textcolor{comment}{% if pointSwarm}
        xc = [1895   2160   2252   2656   3255   2586   1238];
        yc = [3019   3151   2770   2741   2595   1791   2770];
        \textcolor{keyword}{for} i=numel(xc):-1:1
            x((i-1)*Np+1:i*Np) = xc(i); 
            y((i-1)*Np+1:i*Np) = yc(i);
        \textcolor{keyword}{end}
        
        P = Moc(gr,Qx,Qy,Peff,R,t,x,y,\textcolor{string}{'aL'},aL,\textcolor{string}{'aT'},aT,\textcolor{string}{'Diff'},Diff,\textcolor{string}{'lambda'},lambda);

    \textcolor{keyword}{end}
\textcolor{keyword}{else}  \textcolor{comment}{% uniformly distributed particles (nxn in each cells)}
    n = 3;
\textcolor{comment}{%    [P,Icells] = Moc(gr,Qx,Qy,Peff,R,t,n); \% no dispersion, diffusion, decay}

    P = Moc(gr,Qx,Qy,Peff,R,t,n,\textcolor{string}{'aL'},aL,\textcolor{string}{'aT'},aT,\textcolor{string}{'Diff'},Diff,\textcolor{string}{'lambda'},lambda);

\textcolor{keyword}{end}

\textcolor{comment}{%\% Visualize results}
close all;

set(gca,\textcolor{string}{'nextplot'},\textcolor{string}{'add'},\textcolor{string}{'xlim'},gr.xGr([1 end]),\textcolor{string}{'ylim'},gr.yGr([end 1]));
xlabel(\textcolor{string}{'x [m]'}); ylabel(\textcolor{string}{'y [m]'});
title(\textcolor{string}{'example2: MOC, flow from left to right'});

\textcolor{comment}{% Contour heads}
phiMax = max(Phi(:)); phiMin = min(Phi(:));  hRange = phiMin:(phiMax-phiMin)/25:phiMax;
contourf(gr.xm,gr.ym,Phi,hRange,\textcolor{string}{'edgeColor'},\textcolor{string}{'none'});

gr.plot(\textcolor{string}{'c'}); \textcolor{comment}{% Plot grid on top}

\textcolor{comment}{%\% Show moving particles (stored in struct P)}
time = [P.time];
Np   = numel(P,x);
\textcolor{keyword}{for} it=1:numel(time)/2
    \textcolor{comment}{% Title will change according to passing time}
    ttl = sprintf(\textcolor{string}{'Tracking \%d particles time = \%.0f d'},Np,time(it));
    \textcolor{keyword}{if} it==1
        \textcolor{comment}{% First loop, title and plot}
        ht = title(ttl);
        h = plot(P(it).x,P(it).y,\textcolor{string}{'r.'},\textcolor{string}{'markerSize'},3);
    \textcolor{keyword}{else}
        \textcolor{comment}{% Subsequent loops, reset title and points}
        set(ht,\textcolor{string}{'string'},ttl);
        set(h,\textcolor{string}{'xData'},P(it).x,\textcolor{string}{'yData'},P(it).y);
        drawnow();  \textcolor{comment}{% necessary to update plot}
        pause(0.1); \textcolor{comment}{% smooth movie}
    \textcolor{keyword}{end}
\textcolor{keyword}{end}
    
\textcolor{comment}{%\% Plot cumulative number of particles captured by wells}
figure; hold on; grid on;
ht = title(sprintf(\textcolor{string}{'Cumulative particles captured by the wells, total simulated = \%d'},Np));
xlabel(\textcolor{string}{'time'}); ylabel(\textcolor{string}{'total nr of particles captured'});

\textcolor{comment}{% Make array of cell nrs in which particles are after each time step}
PIcell = [P.Icells];

leg = [];
\textcolor{keyword}{for} iw = numel(Idwell):-1:1
    h(iw) = plot(t,sum(PIcell==Idwell(iw),1),clr(iw));
    leg\{iw\} = sprintf(\textcolor{string}{'well \%d'},iw);
\textcolor{keyword}{end}
legend(h,leg\{:\},2);

\textcolor{comment}{%\% Plot total mass caputured by well where 1 particle represents 1 mass unit}

\textcolor{comment}{% Update title of previous graph using handle ht.}
set(ht,\textcolor{string}{'string'},sprintf(\textcolor{string}{'\%s, with and without decay'},get(ht,\textcolor{string}{'string'})));

\textcolor{comment}{% This mass is subject to decay}
\textcolor{keyword}{if} isfield(P,\textcolor{string}{'mass'})
    clr = \textcolor{string}{'brgkmcy'};

    mass   = [P.mass];
    \textcolor{keyword}{for} iw = numel(Idwell):-1:1
        \textcolor{comment}{% Add to previous plot for comparison}
        h(iw) = plot(t,sum(mass.*(PIcell==Idwell(iw)),1),clr(iw));
    \textcolor{keyword}{end}
    \textcolor{comment}{% Also refer to legend of previous plot}
\textcolor{keyword}{end}

\textcolor{comment}{%\% Plot vectors indicating flow direction and strength}

figure; hold on;
xlabel(\textcolor{string}{'x [m]'}); ylabel(\textcolor{string}{'y [m]'});
title(\textcolor{string}{'Flow model with Quiver'});

\textcolor{comment}{% Contour heads}
phiMax = max(Phi(:)); phiMin = min(Phi(:));  hRange = phiMin:(phiMax-phiMin)/25:phiMax;
contourf(gr.xm,gr.ym,Phi,hRange,\textcolor{string}{'edgeColor'},\textcolor{string}{'none'});

\textcolor{comment}{% Show arrows of flow direction and magnitude}
qx = [Qx(:,1), Qx, Qx(:,end)]; qx = 0.5*(qx(:,1:end-1) + qx(:,2:end));
qy = [Qy(1,:); Qy; Qy(\textcolor{keyword}{end},:)]; qy = 0.5*(qy(1:end-1,:) + qy(2:\textcolor{keyword}{end},:));
quiver(gr.Xm,gr.Ym,qx,qy);

hb = colorbar; set(get(hb,\textcolor{string}{'title'}),\textcolor{string}{'string'},\textcolor{string}{'head [m]'})  \textcolor{comment}{% Colorbar}

\textcolor{comment}{%\% Check water balance}
fprintf(\textcolor{string}{'Water balances:\(\backslash\)n'});
fprintf(\textcolor{string}{'Total water balance = \%10g (should be zero)\(\backslash\)n'},sum(Q(IBOUND\~{}=0)));
fprintf(\textcolor{string}{'Total recharge (active  cells) = \%10.0f m3/d\(\backslash\)n'},sum(Q(IBOUND>0)));
fprintf(\textcolor{string}{'Total discharge(fixhd + wells) = \%10.0f m3/d\(\backslash\)n'},sum(Q(IBOUND<0)));

\end{alltt}
